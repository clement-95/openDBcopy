configurations {
    hibernatetool
}

dependencies {
    implementation group: 'org.hibernate', name: 'hibernate-core', version: '5.3.0.CR1'
    hibernatetool group: 'org.hibernate', name: 'hibernate-tools', version: '5.2.10.Final'
    hibernatetool group: 'log4j', name: 'log4j', version: '1.2.17'
    hibernatetool group: 'mysql', name: 'mysql-connector-java', version: '6.0.6'

    testImplementation group: 'com.h2database', name: 'h2', version: '1.4.196'
}

version = 0.2

task preparehbm {
    mkdir("$projectDir/hbm/src")
    mkdir("$projectDir/hbm/classes")
}

task cleanhbm(type: Delete) {
    delete fileTree("$projectDir/hbm") {
        include '**/*.java', '**/*.class'
    }
}

task deploy(dependsOn: ['clean', 'compile', 'createjar'], overwrite: true) {
    delete "$OPENDBCOPY_HOME/plugins/$project.name"

    copy {
        from pluginFile
        from guiFile
        from 'codegen_config.xml'
        from 'build.gradle'
        from 'README'
        into "$OPENDBCOPY_HOME/plugins/$project.name"
    }

    copy {
        from libsDir
        into "$OPENDBCOPY_HOME/plugins/$project.name/$libsDirName"
    }

    copy {
        from "$projectDir/hbm"
        into "$OPENDBCOPY_HOME/plugins/$project.name/hbm"
    }
}

task hbm2java(dependsOn: 'cleanhbm') {//, type: JavaCompile
    doLast {
        ant.taskdef(name: 'hibernatetool',
                    classname: 'org.hibernate.tool.ant.HibernateToolTask',
                    classpath: configurations.hibernatetool.asPath)
        ant.hibernatetool(destdir: "$projectDir/hbm/src") {
            configuration(propertyfile: "$projectDir/hbm/hibernate.properties") {
                ant.fileSet(dir: "$projectDir/hbm") {
                    include(name: "**/*.hbm.xml")
                }
            }
            hbm2java(jdk5: true)
        }

//        source = "$projectDir/hbm/src"
//        setDestinationDir(file("$projectDir/hbm/classes"))
//        classpath = sourceSets.main.compileClasspath
    }
}

